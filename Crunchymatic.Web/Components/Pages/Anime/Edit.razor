@page "/anime/{AnimeId:int}/edit"
@using System.Globalization
@using Crunchymatic.Web.Models
@using Microsoft.EntityFrameworkCore
@using NuGet.Packaging
@inject IDbContextFactory<CrunchymaticContext> DbFactory
@inject ILogger<Create> Logger
@inject NavigationManager Navigation

@if (Anime == null)
{
    <PageTitle>Some anime</PageTitle>
}
else
{
    <PageTitle>@Anime.EnglishTitle</PageTitle>
}

@if (Anime == null)
{
    <p aria-busy="true">Loading anime…</p>
    return;
}

<h3>@Anime.EnglishTitle
    <a href="@($"https://www.crunchyroll.com/series/{Anime.CrunchyrollSeriesId}/")" target="_blank">
        <CrunchyLogo style="max-height: 1rem;"/>
    </a>
</h3>

<p>@Anime.EpisodeChecks.Count entries. </p>
<NavLink href="@($"/anime/{AnimeId}/add-check")" role="button" class="secondary">Add Check</NavLink>
<hr/>

<div class="overflow-auto">
    <table>
        <colgroup>
            <col span="1" style="min-width: 24px;"/>
            <col span="1" style="min-width: 150px;"/>
            <col span="1" style="min-width: 150px;"/>
            <col span="1" style="min-width: 150px;"/>
        </colgroup>

        <thead>
        <tr>
            <th scope="col">Ep</th>
            <th scope="col">Release date</th>
            <th scope="col">Date fetched</th>
            <th scope="col"></th>
        </tr>
        </thead>
        <tbody>
        @foreach (var episode in Anime.EpisodeChecks)
        {
            <tr>
                <th scope="row">@episode.EpisodeNumber
                </th>
                <td data-tooltip="@episode.EpisodeReleased.ToString("yyyy-MM-dd HH:mm:ss", CultureInfo.InvariantCulture)">@episode.EpisodeReleased.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture)</td>
                <td data-tooltip="@episode.TimeSubtitlesGrabbed.ToString("yyyy-MM-dd HH:mm:ss", CultureInfo.InvariantCulture)">@episode.TimeSubtitlesGrabbed.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture)</td>
                <td><a href="@($"/check/{episode.Id}")">Edit</a></td>
            </tr>
        }
        </tbody>
    </table>
</div>

<hr/>
<EditForm Model="Model" OnValidSubmit="OnValidAnimeEditFormSubmit" FormName="EditAnimeEntry">
    <DataAnnotationsValidator/>
    <ValidationSummary/>
    <AnimeForm Model="Model"/>
    <button type="submit">Edit</button>
</EditForm>

<hr/>

<details>
    <summary>Delete @Anime.EnglishTitle</summary>
    <p>Press the button below to delete <b>@Anime.EnglishTitle</b>. This cannot be undone!</p>
    <form method="post" @formname="DeleteAnimeEntry" @onsubmit="OnValidDeleteAnimeSubmit">
        <AntiforgeryToken/>
        <button type="submit" style="width: auto;">Delete!</button>
    </form>
</details>

@code {

    [Parameter] public int AnimeId { get; set; }

    private Anime? Anime { get; set; }
    [SupplyParameterFromForm] private AnimeForm.AnimeDTO? Model { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await using var context = await DbFactory.CreateDbContextAsync();

        var anime = await context.Anime
            .Include(x => x.EpisodeChecks)
            .ThenInclude(x => x.CheckedSubtitles)
            .FirstOrDefaultAsync(x => x.Id == AnimeId);

        if (anime == null)
        {
            Navigation.NotFound();
            return;
        }

        Anime = anime;
        Model ??= new AnimeForm.AnimeDTO()
        {
            EnglishTitle = Anime.EnglishTitle,
            CrunchyrollSeriesId = Anime.CrunchyrollSeriesId,
            CrunchyrollSeasonId = Anime.CrunchyrollSeasonId,
            SheetName = Anime.SheetName
        };
    }

    private async Task OnValidAnimeEditFormSubmit()
    {
        Logger.LogInformation("Editing anime entry for {thing}", Model);

        await using var context = await DbFactory.CreateDbContextAsync();

        System.Diagnostics.Debug.Assert(Model != null);
        System.Diagnostics.Debug.Assert(Model.EnglishTitle != null);
        System.Diagnostics.Debug.Assert(Model.CrunchyrollSeasonId != null);
        System.Diagnostics.Debug.Assert(Model.CrunchyrollSeriesId != null);

        var anime = await context.Anime.FirstOrDefaultAsync(x => x.Id == AnimeId);

        if (anime == null)
        {
            Navigation.Refresh();
            return;
        }

        anime.EnglishTitle = Model.EnglishTitle;
        anime.CrunchyrollSeasonId = Model.CrunchyrollSeasonId;
        anime.CrunchyrollSeriesId = Model.CrunchyrollSeriesId;
        anime.SheetName = Model.SheetName;

        Anime = anime;

        await context.SaveChangesAsync();
    }

    private async Task OnValidDeleteAnimeSubmit()
    {
        Logger.LogInformation("Deleting anime entry for {animeTitle} ({animeId})", Anime?.EnglishTitle, AnimeId);

        await using var context = await DbFactory.CreateDbContextAsync();

        await context.Anime.Where(x => x.Id == AnimeId).ExecuteDeleteAsync();
        
        Navigation.NavigateTo("/anime");
    }

}